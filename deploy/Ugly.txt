<!DOCTYPE html>
<html>
<head>
    <title>user-story-ancestor-grid-1.0.1</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Wed Oct 03 2018 16:21:52 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Wed Oct 03 2018 16:21:52 GMT+0000 (UTC)";
        var CHECKSUM = 14725052224;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:Ext.String.format("Build date/time: {0} ({1})",APP_BUILD_DATE,BUILDER)})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("CArABU.technicalservices.AncestorTemplateColumn",{extend:"Ext.grid.column.Template",alias:["widget.ancestortemplatecolumn"],align:"right",initComponent:function(){var a=this;a.tpl=new Ext.XTemplate('<tpl><div style="text-align:right;">{[this.getAncestorString(values)]}</div></tpl>',{ancestorName:a.ancestorName,getAncestorString:function(a){return a.FormattedID?Ext.String.format('<a href="{0}" target="blank">{1}</a>: {2}',Rally.util.Navigation.getDetailUrl(a),a.FormattedID,a.Name):""}}),a.hasCustomRenderer=!0,a.callParent(arguments)},getValue:function(){return values[this.dataIndex]||0},defaultRenderer:function(a,b,c){var d=Ext.apply({},c.get(this.ancestorName));return this.tpl.apply(d)}}),Ext.define("CArABU.technicalservices.FileUtilities",{singleton:!0,saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"===d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.override(Rally.ui.grid.TreeGrid,{_mergeColumnConfigs:function(a,b){var c=_.map(a,function(a){var c=_.find(b,{dataIndex:this._getColumnName(a)});return c?this._getColumnConfigFromColumn(c):a},this);return c=c.concat(this.config.derivedColumns)},_getColumnConfigsBasedOnCurrentOrder:function(a){return _(this.headerCt.items.getRange()).map(function(b){return _.contains(a,b.dataIndex)?b.dataIndex:_.find(a,{dataIndex:b.dataIndex,text:b.text})}).compact().value()},_restoreColumnOrder:function(a){var b=this._getColumnConfigsBasedOnCurrentOrder(a),c=_.filter(a,function(a){return!_.find(b,{dataIndex:a.dataIndex})||Ext.isString(a)});return b.concat(c)},_applyStatefulColumns:function(a){this.alwaysShowDefaultColumns&&_.each(this.columnCfgs,function(b){_.any(a,{dataIndex:this._getColumnName(b)})||a.push(b)},this),this.config&&this.config.derivedColumns?this.columnCfgs=a.concat(this.config.derivedColumns):this.columnCfgs=a}}),Ext.override(Rally.ui.inlinefilter.AdvancedFilterRows,{_getRowConfig:function(){return Ext.merge({xtype:"rallyancestorfilterrow",autoExpand:this.autoExpand,model:this.model,context:this.context,focusPropertyField:!1,operatorFieldConfig:this.operatorFieldConfig,propertyFieldConfig:this.propertyFieldConfig,listeners:{addrow:function(){this._addRow(!0)},removerow:this._removeRow,scope:this}},this.rowConfig)}}),Ext.define("user-story-ancestor-grid",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},integrationHeaders:{name:"user-story-ancestor-grid"},config:{defaultSettings:{query:""}},launch:function(){this.fetchPortfolioItemTypes().then({success:this.initializeApp,failure:this.showErrorNotification,scope:this})},showErrorNotification:function(a){Rally.ui.notify.Notifier.showError({message:a})},initializeApp:function(a){this.portfolioItemTypeDefs=Ext.Array.map(a,function(a){return a.getData()}),this._buildGridboardStore()},getFeatureName:function(){return this.getFeatureTypePath().replace("PortfolioItem/","")},getFeatureTypePath:function(){return this.portfolioItemTypeDefs[0].TypePath},getPortfolioItemTypePaths:function(){return _.pluck(this.portfolioItemTypeDefs,"TypePath")},fetchPortfolioItemTypes:function(){return this.fetchWsapiRecords({model:"TypeDefinition",fetch:["TypePath","Ordinal","Name"],context:{workspace:this.getContext().getWorkspace()._ref},filters:[{property:"Parent.Name",operator:"=",value:"Portfolio Item"},{property:"Creatable",operator:"=",value:"true"}],sorters:[{property:"Ordinal",direction:"ASC"}]})},fetchSnapshots:function(a){var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.lookback.SnapshotStore",a).load({callback:function(a,c){c.wasSuccessful()?b.resolve(a):b.reject("Failed to load snapshots: ",c&&c.error&&c.error.errors.join(","))}}),b},getQueryFilter:function(){var a=this.getSetting("query");return a&&a.length>0?(this.logger.log("getQueryFilter",Rally.data.wsapi.Filter.fromQueryString(a)),Rally.data.wsapi.Filter.fromQueryString(a)):[]},_buildGridboardStore:function(){this.logger.log("_buildGridboardStore"),this.removeAll(),Ext.create("Rally.data.wsapi.TreeStoreBuilder").build({models:this.getModelNames(),enableHierarchy:!0,fetch:[this.getFeatureName(),"ObjectID"],filters:this.getQueryFilter()}).then({success:this._addGridboard,failure:this.showErrorNotification,scope:this})},getModelNames:function(){return["HierarchicalRequirement"]},getFeatureAncestorHash:function(){return this.featureAncestorHash||(this.featureAncestorHash={}),this.featureAncestorHash},setAncestors:function(a){for(var b=this.getFeatureAncestorHash(),c=this.getFeatureName(),d=0;d<a.length;d++){var e=a[d],f=e.get(c);if(f)for(var g=f.ObjectID,h=b[g],i=1;i<this.portfolioItemTypeDefs.length;i++){var j=this.portfolioItemTypeDefs[i].TypePath.toLowerCase().replace("portfolioitem/","");h&&h[j]?e.set(j,h[j]):e.set(j,null)}}},updateFeatureHashWithWsapiRecords:function(a){var b={},c=[],d=this.getPortfolioItemTypePaths()[0].toLowerCase(),e=_.map(this.getPortfolioItemTypePaths(),function(a){return a.toLowerCase().replace("portfolioitem/","")});Ext.Array.each(a,function(a){Ext.Array.each(a,function(a){b[a.get("ObjectID")]=a.getData(),a.get("_type")===d&&c.push(a)})}),this.logger.log("updateFeatureHashWithWsapiRecords",e,a);var f=this.getFeatureAncestorHash();Ext.Array.each(c,function(a){var c=a.get("Parent")&&a.get("Parent").ObjectID||null,d=a.get("ObjectID");if(f[d]||(f[d]=b[d],Ext.Array.each(e,function(a){f[d][a]=null})),c&&f[d])do{var g=b[c]||null,h=b[c]&&b[c]._type.replace("portfolioitem/","");f[d]&&(f[d][h]=g,c=g&&g.Parent&&g.Parent.ObjectID||null)}while(null!==c)})},fetchAncestors:function(a){for(var b=Ext.create("Deft.Deferred"),c=[],d=0;d<this.getPortfolioItemTypePaths().length;d++){for(var e=this.getPortfolioItemTypePaths()[d],f=["ObjectID"],g=0;d>g;g++)f.unshift("Children");var h=f.join("."),i=_.map(a,function(a){return{property:h,value:a}});i=Rally.data.wsapi.Filter.or(i),this.logger.log("type",e,i.toString()),c.push(this.fetchWsapiRecords({model:e,fetch:["FormattedID","Name","Parent","ObjectID"],enablePostGet:!0,limit:1/0,pageSize:1e3,context:{project:null},filters:i}))}return this.setLoading("Loading Ancestor data..."),Deft.Promise.all(c).then({success:function(a){b.resolve(a)},failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this),b},updateStories:function(a,b,c,d){if(this.logger.log("updateStories",c,d),0!==c.length&&"hierarchicalrequirement"===c[0].get("_type")){var e=this.getFeatureName(),f=this.getFeatureAncestorHash(),g=[];Ext.Array.each(c,function(a){var b=a.get(e);b&&!f[b.ObjectID]&&(Ext.Array.contains(g,b.ObjectID)||g.push(b.ObjectID))},this),this.logger.log("featureOids",g),g.length>0?this.fetchAncestors(g).then({success:function(a){this.updateFeatureHashWithWsapiRecords(a),this.setAncestors(c)},failure:this.showErrorNotification,scope:this}):this.setAncestors(c)}},_addGridboard:function(a){for(var b=1;b<this.portfolioItemTypeDefs.length;b++){var c=this.portfolioItemTypeDefs[b].Name.toLowerCase();a.model.addField({name:c,type:"auto",defaultValue:null})}a.on("load",this.updateStories,this),this.add({xtype:"rallygridboard",context:this.getContext(),modelNames:this.getModelNames(),toggleState:"grid",plugins:this.getGridPlugins(),stateful:!1,gridConfig:{store:a,storeConfig:{filters:this.getQueryFilter()},columnCfgs:this.getColumnConfigs(),derivedColumns:this.getDerivedColumns()},height:this.getHeight()})},getGridPlugins:function(){return[{ptype:"rallygridboardaddnew"},{ptype:"rallygridboardfieldpicker",headerPosition:"left",modelNames:this.getModelNames(),alwaysSelectedValues:[this.getFeatureName()],stateful:!0,margin:"3 3 3 25",stateId:this.getContext().getScopedStateId("ancestor-columns-1")},{ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("ancestor-filters"),modelNames:this.getModelNames(),margin:3,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["ArtifactSearch","Owner","ModelType"]},advancedFilterPanelConfig:{advancedFilterRowsConfig:{flex:2}}}}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export...",handler:this._export,scope:this},{text:"Export Stories and Tasks...",handler:this._deepExport,scope:this}],buttonConfig:{margin:3,iconCls:"icon-export"}}]},getExportFilters:function(){var a=this.getQueryFilter(),b=this.down("rallygridboard").currentCustomFilter.filters||[];return a.length>0&&b.length>0?a=a.and(b):b.length>0&&(a=b),this.logger.log("getExportFilters",a.toString()),a},updateExportStories:function(a){var b=Ext.create("Deft.Deferred");this.logger.log("updateExportStories",a),(0===a.length||"hierarchicalrequirement"!==a[0].get("_type"))&&b.resolve([]);var c=this.getFeatureName(),d=this.getFeatureAncestorHash(),e=[];return Ext.Array.each(a,function(a){var b=a.get(c);b&&!d[b.ObjectID]&&(Ext.Array.contains(e,b.ObjectID)||e.push(b.ObjectID))},this),this.logger.log("featureOids",e),e.length>0?this.fetchAncestors(e).then({success:function(c){this.updateFeatureHashWithWsapiRecords(c),this.setAncestors(a),b.resolve(a)},failure:function(a){b.reject(a)},scope:this}):(this.setAncestors(a),b.resolve(a)),b},_deepExport:function(){this._export(!0)},_export:function(a){var b=this.getExportFilters(),c=this.down("rallytreegrid").columns,d=_.filter(c,function(a){return"Rank"!==a.text&&("rallyfieldcolumn"===a.xtype||"treecolumn"===a.xtype)}),e=this.getDerivedColumns(),f=Ext.Array.merge(d,e),g=_.pluck(d,"dataIndex");g.push("ObjectID"),a&&g.push("Tasks"),Ext.Array.contains(g,this.getFeatureName())||g.push(this.getFeatureName()),this.setLoading("Loading data to export..."),this.logger.log("columns",c),this.fetchWsapiRecords({model:"HierarchicalRequirement",fetch:g,filters:b,limit:"Infinity"}).then({success:this.updateExportStories,scope:this}).then({success:function(b){if(a)this._exportTasks(b,g,f);else{var c=this.getExportCSV(b,f),d=Ext.String.format("export-{0}.csv",Ext.Date.format(new Date,"Y-m-d-h-i-s"));CArABU.technicalservices.FileUtilities.saveCSVToFile(c,d)}},failure:this.showErrorNotification,scope:this}).always(function(){this.setLoading(!1)},this)},_exportTasks:function(a,b,c){for(var d=[],e=0;e<a.length;e++)a[e].get("Tasks")&&a[e].get("Tasks").Count&&d.push(a[e].get("ObjectID"));var f=Ext.Array.map(d,function(a){return{property:"WorkProduct.ObjectID",value:a}});f=Rally.data.wsapi.Filter.or(f),b.push("WorkProduct"),this.fetchWsapiRecords({model:"Task",fetch:b,filters:f,limit:"Infinity",enablePostGet:!0}).then({success:function(b){this.logger.log("exportTasks",b.length);for(var d={},e=0;e<b.length;e++)d[b[e].get("WorkProduct").ObjectID]||(d[b[e].get("WorkProduct").ObjectID]=[]),d[b[e].get("WorkProduct").ObjectID].push(b[e]);for(var f=[],e=0;e<a.length;e++){f.push(a[e]);var g=d[a[e].get("ObjectID")];g&&g.length>0&&(f=f.concat(g))}c.push({dataIndex:"WorkProduct",text:"User Story"});var h=this.getExportCSV(f,c),i=Ext.String.format("export-{0}.csv",Ext.Date.format(new Date,"Y-m-d-h-i-s"));CArABU.technicalservices.FileUtilities.saveCSVToFile(h,i)},failure:function(a){var a="Unable to export tasks due to error:  "+a;this.showErrorNotification(a)},scope:this})},getExportCSV:function(a,b){var c=_.filter(b,function(a){return a.dataIndex||null}),d=_.map(c,function(a){return"ID"===a.text?"Formatted ID":a.text}),e=_.map(c,function(a){return a.dataIndex}),f=this.getDerivedColumns();this.logger.log("getExportCSV",d,e),Ext.Array.each(f,function(a){d.push(a.text)});for(var g=[d.join(",")],h=0;h<a.length;h++){for(var i=[],j=a[h],k=0;k<e.length;k++){var l=j.get(e[k]);Ext.isObject(l)&&(l=l.FormattedID||l._refObjectName),i.push(l||"")}Ext.Array.each(f,function(a){var b=j.get(a.ancestorName);b?i.push(Ext.String.format("{0}: {1}",b.FormattedID,b.Name)):i.push("")}),i=_.map(i,function(a){return Ext.String.format('"{0}"',a.toString().replace(/"/g,'""'))}),g.push(i.join(","))}return g.join("\r\n")},getColumnConfigs:function(){var a=[{dataIndex:"Name",text:"Name"},{dataIndex:"ScheduleState",text:"Schedule State"},{dataIndex:this.getFeatureName(),text:this.getFeatureName()}].concat(this.getDerivedColumns());return this.logger.log("cols",a),a},getDerivedColumns:function(){for(var a=[],b=1;b<this.portfolioItemTypeDefs.length;b++){var c=this.portfolioItemTypeDefs[b].TypePath.toLowerCase().replace("portfolioitem/","");a.push({ancestorName:c,xtype:"ancestortemplatecolumn",text:this.portfolioItemTypeDefs[b].Name})}return a},fetchWsapiRecords:function(a){var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.wsapi.Store",a).load({callback:function(c,d){d.wasSuccessful()?b.resolve(c):b.reject(Ext.String.format("Failed to fetch {0} records: {1}",a.model,d&&d.error&&d.error.errors.join(",")))}}),b},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},getSettingsFields:function(){return[{xtype:"textarea",fieldLabel:"Query Filter",name:"query",anchor:"100%",cls:"query-field",margin:"0 70 0 0",labelAlign:"right",labelWidth:100,plugins:[{ptype:"rallyhelpfield",helpId:194},"rallyfieldvalidationui"],validateOnBlur:!1,validateOnChange:!1,validator:function(a){try{return a&&Rally.data.wsapi.Filter.fromQueryString(a),!0}catch(b){return b.message}}}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),this._buildGridboardStore()}});

               Rally.launchApp('user-story-ancestor-grid', {
                   name: 'user-story-ancestor-grid'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}
    </style>

</head>
<body></body>
</html>